<!--
author:   Daniel Nutting

version:  0.0.1

language: en

narrator: US English Female

comment:  Pen Testing Course for Florida Southern College
-->

# Penetration Testing

Foundations to Penetration Testing

# Orientation

What is the objective?
Fastest path to compromise?
Information Disclosure?
Realizing Risk?

## Course Ethics

## CIA Triad

Confidentiality
Integrity
Availability

Trust

## Notetaking

Information collected
Actions performed
Note taking goals:
  - Distinguish between the pen tester and a threat actor
  - Clean up
  - Evidence
  - Repeatability

Things to consider in note taking.

Screenshots

Timestamps

## Scoping

IP ranges
Servernames
Applications

Trust but verify

Secrecy

Impact

Define out of scope (e.g. don't touch the OT network)

## Objectives, Strategy, and Tactics

Time is a valuable, limited resource.

Goal orienting

Parallelization, Dependencies, Task Flows

Organization

Hail Marys

Rabbit Holes

Let the goal of the Pen Test address how you prioritize your time.

## Operating in Obscurity

Mental Model:

- Known

  - How discovered
  - Last verified

- Unknown (i.e. Need to Learn)

  - Testing Options
  - Dependencies

A penetration test involves continuously interating through defining unknowns, and identifying paths to make them known.

``` ascii
+-----------+               +---------+
|  Unknown  |---> Tool ---> |  Known  |
+-----------+               +---------+
```

Things that can change knowns:

- The client themselves.

  - Power down
  - Weekend and holiday
  - Customer impact
  - Approved changes, new deployments
  - Patching

- Other threat actors

  - Fight for dominance
  - Drive by exploitation

- You

  - Accidental impact
  - Network exhaustion
  - Shutting down systems
  - Getting caught

## Penetration Testing vs Red Teaming

## Test Phases and Structure

# Information Gathering

Often the first step in a penetration test is focused on gathering information. Consider the mental model we're using. Identifying unknowns and then selecting tools to convert them to knowns.

``` ascii
+-----------+               +---------+
|  Unknown  |---> Tool ---> |  Known  |
+-----------+               +---------+
```

Let's exemplify this with a simplified penetration test. Imagine we are assessing the security of a single web server. Based on the scope from the client we likely know:

- Domain Name
- IP address

Now consider all the things we do NOT know:

- Web server software
- Host operating system
- Plugins
- Usernames and passwords
- Server administrators
- Email addresses
- Open ports
- Cohosted applications
- Backend database connections
- Network and Web Application Firewalls
  
  ... The list goes on

Each of these elements could potentially lead further along the path to compromise.

In order to answer these questions, we need to employ various techniques that allow us to discover this information both *passively* and *actively*.

## Passive vs Active

Passive Reconnaissance
======================
**Passive Reconnaissance** is when we collect information about the target ~~without~~ engaging the target in any way. The nature of the internet causes people and organizations to leave bread crumbs of information scattered around. Some of that information is intentional. The internet was built to allow people to *find* information after all. Examples of passive reconnaissance include searching for LinkedIn profiles, news articles, or querying the domain registrar for information. In the last example, this is considered passive because the query is done against a third party, not the client. Some passive reconnaissance may collect stale or expired information.

Active Reconnaissance
=====================
**Active Reconnaissance** is when we collect information about the target by ~~stimulating~~ a response. During active reconnaissance, our scans are interacting with the client's infrastructure and soliciting a response. Examples of active reconnaissance include port scanning, vulnerability scanning, and user account bruteforcing. Active reconnaissance is unlikely to collect stale information. However, a savvy organization may seed deceptive information intentionally to thwart our approach.

Covert Reconnaissance
=====================
**Covert Reconnaissance** is a blend between the two. Most organizations on the internet want to interact with others, especially customers. As such, there is a standard collection of behaviors that should be seen as normal by any monitoring system. Examples of covert reconnaissance would be browsing web pages just like a customer would. At least as far as it appears to the web server.  We may be fiendishly taking notes and saving pcaps while doing so. But, as long as it presents just like a normal user, the target should be none the wiser.

Generally penetration testing literature only discusses Passive and Active, with disagreements as to where mimicking standard users belongs. To address this, we're identifying it as a third type.

A last type of reconnaissance may include a **Watering Hole**, where we, as an attacker, set up infrastructure and allow the target to engage with it on their own. This is generally uncommon, but can be a component of an overall attack.
  
## Storytelling

While engaging with a penetration test there are two general stories or narratives that are unfurling. The first is the one we are discovering and learning about the target organization. As we saw in our first exposure with the "Broken" web machine, the web page was down for maintenance and the administrator was testing new Content Management Systems (CMS). It appears the administrator found a free CMS online and did not review the code. We discovered that in our information gathering to gain a foothold onto the server.

The second narrative involves the role or roles we take on as we compromise different user accounts. When conducting a test, our interactions will leave evidence behind. We want to be congnizant of how our interactions will impact the infrastructure, and whether the traces of our behavior look legitimate.

At this stage, let's focus on the first narrative, that of the defending organization.

Within this narrative there is a setting, the organizational infrastructure, and there are actors, the users and administrators of the system. *Both the infrastructure and the users will have vulnerabilities to exploit.* During our first iteration of information gathering, we will typically follow a structured, methodical approach to identify and understand the setting and actors which are public facing. This is collection of information is known as the attack surface.

<!-- style="display:none" -->
<div style="display:none">
Author's note: Consider expanding around:
- Interacting with the target. 

  -- Mimic customer? 
  -- Mimic Vendor? 
  -- Behave differently?

Infrastructure, Assets, and Personnel
</div>

## Attack Surface

The victim's attack surface is all of the public facing interfaces through which we can deploy our initial capabilities. The attack surface includes things like routers, web servers, firewalls, vpn terminations, file shares, and even email addresses. In other words, the attack surface is the collection of destinations to which nefarious data can be sent.

The attack surface can also be considered in a more nuanced approach. For instance, a web application will have an attack surface made up of the API endpoints, user accounts, code pipeline, and web admin email addresses.

Both attackers and defenders regularly assess attack surfaces. For defenders, reducing the attack surface narrows the entry points for attackers to breach an organization. For attackers, understanding the attack surface orients their intial plan of attack.

https://cheatsheetseries.owasp.org/cheatsheets/Attack_Surface_Analysis_Cheat_Sheet.html

## Diamond Model

In the Detection Engineering class, we discussed the [Diamond Model](https://www.threatintel.academy/wp-content/uploads/2020/07/diamond-model.pdf) for mapping threat intelligence. This is used by defenders to understand the adversary and how they are likely to interact with the victim organization.

``` ASCII
               Adversary
                  /\
                 /  \
                /    \
Infrastructure +------+ Capability
                \    /
                 \  /
                  \/
                Victim
```

To summarize, the Diamond Model describes the Adversary, **their** infrastructure, **their** capabilities, and how those can be deployed against the victim. In the Diamond Model documentation, the victim is defined as follows:

> A *victim* is the target of the adversary and against whom vulnerabilities and exposures are exploited and capabilities used.
> 
> Victim Personae are the people and organizations being targeted whose assets are being exploited and attacked.
> 
> Victim Assets are the ~~attack surface~~ and consist of the set of networks, systems, hosts, email addresses, IP addresses, social networking accounts, etc. against which the adversary directs their capabilities.
>
> -- The Diamond Model of Intrusion Analysis; Caltagirone, Pendergrast, and Betz

*Inverted* Diamond Model
========================

In our course, we're going to leverage a similar style of thinking, but now with a focus on the Victim. This means, in our information gathering, we want to collect information about the victim's assets and personae, so that we can select appropriate capabilities for our attacks.

``` ASCII
         Victim
          /\
         /  \
        /    \
Assets +------+ Personae
        \    /
         \  /
          \/
   Attack Capability
```

After practice and gathering experience, we will develop an inventory of capabilities that we can quickly leverage againt the victim. And as we deploy those capabilities we will continuously learn more and more about the victim.

## Open Source Intelligence (OSINT)

The term OSINT is a fancy way of saying, it was easily accessible on the internet. In general, "open source" is *free to read*. The term comes from open source software, where the underlying source code was open to public scrutiny.

Open Source Intelligence is thus free to read. In practice there are some resources that ask for money for amplified data. Often times these sites make searching and curating open source data practical, where doing so on our own is not.

We've all received the random phone number, which did not leave a voice mail. I'm sure we've all also typed the phone number in Google to find information about it. This is a prime example of executing OSINT in our daily lives.

The [OSINT Framework](https://osintframework.com/)[^1] is a website that inventories many, many different sources and tools for collecting information from online sources. This can be used to ideate and align to online repositories. For instance, if we wanted to review Business Records about our topic, we can navigate through the OSINT framework -> Annual Reports -> Public Register Online website. 
Or, perhaps we want to see if there are any publicly accessible webcams in the area. So we'd navigate Images / Videos / Docs -> Webcams -> Insecam.

This list, just like any attempting to inventory things on the internet, is incomplete. We will find other OSINT tools and resources. Moreover, this list will eventually become stale as the maintainer loses interest or attention to their project.

[^1]: As of writing this, this website is randomly throwing SSL handshake errors. A couple of refreshes eventually allows for a good connection.

#### Infrastructure

The first actionable step in our information gathering journey starts with the victim's infrastructure. Here we want to collect information about the servers, software, domains, and the other supporting elements. The OSINT Framework only lists Domain Name and IP & MAC Address. While there is plenty more infrastructure to info gather about, other aspects such as software, may require *active* instead of passive techniques.

##### Domain Intelligence

The internet's Domain Name System obligates organizations to describe themselves when registering their domain. And registering a domain allows customers to easily navigate to their website, instead of needing to memorize IP addresses.[^1] Registering a domain involves two primary steps. First, an organization registers with a Name Registrar. This is an authoritative entity that is allowed to dole out exclusive and unique domains. 

[^1] Fewer and fewer websites are navigable with only an IP address. Many web servers actually share a single IP address, and intelligence application management recognizes which website the user wants based on the domain being requested. Additionally, since normal humans don't normally surf the web using IP addresses, many web servers are configured to just reject requests that do not use domains. [ICANN](https://www.icann.org/en/accredited-registrars) manages a list of accredited registrars who are permitted to do this for generic top level domains ([gTLDs](https://icannwiki.org/Generic_top-level_domain)). These registrars collect information about the organization, including a named representative, mailing address, and contact information, and most importantly, the authoritative *Name Servers*. This information is then added to the ICANN registry.

Name Servers are responsible for servicing detailed information about the domain, particularly which IP addresses are associated with the domain.

Whois Command
=============

Pretty much every Domain Registrar provides a whois interface for examining this registration information. And generally, we could query the information for a domain from any registrar, even if they did not originally register the domain. This can be done in the Kali command line interface using the `whois` command. Or often directly on a registrar's webiste.

Whois tools search for objects in an [RFC 3912](https://www.rfc-editor.org/rfc/rfc3912) database. Whois servers typically listen on TCP port 43 for requests. the `whois` command will manage that for us.

In Kali, execute the following:

`whois flsouthern.edu`

When was the domain record activated?

[( )] 01-Jan-1990
[(x)] 07-Mar-1996
[( )] 10-Oct-2002
[( )] 03-Jun-2024
[[?]] **Not** when the record expires or is last updated.

Online Whois Tools
==================

Many registrars have an online whois tool as well.

Navigate to [whois.com](https://www.whois.com/whois/).

Execute a whois using whois.com for the domain `flsouthern.edu`. What is the authoritative whois database for this domain?

    [[EDUCAUSE]]
    [[?]] The name of the database is in all caps.
    [[?]] The authoritative database is identified in the preamble of the response.

What is the name of the third name server supporting flsouthern.edu?

    [[NS3-01.AZURE-DNS.ORG]]

Consider whether interacting with one of the nameservers could leak information back to flsouthern during a pen test.

Who is the technical contact?

    [[Jean Whitehead]]
    [[?]] Firstname Lastname

What is the technical contact's email address?

    [[jwhitehead@flsouthern.edu]]

Compare the email addresses in the WHOIS results to the user's actual names. Consider what this tells you about potential username structures.

Use the nslookup tool to identify the IP address associated with flsouthern.edu.
Execute a whois against this IP address.

What is the OrgName?

    [[Microsoft Corporation]]
    [[?]] `nslookup flsouthern.edu`
    [[?]] `whois 20.40.202.27`

Execute a whois against publix.com.

What is the Registrar URL?

    [[www.cscprotectsbrands.com]]

What is the Registrant Name?

    [[Pat Caruso]]

Compare the whois results between the web tools and the Kali command line.



, Domain Dossier, 
Private Registration

##### Network Intelligence

IP, ASN, ISP, MaxMind

##### Job Postings

#### Assets

##### Social Information and Context

Search Engines

Wayback Machine

SaaS Publishing (GitHub, WordPress)

Vendors and "Logos"

#### Personnel

##### Social Media

LinkedIn
Conference Sponsorship

##### Email Mining

##### Password Reuse

### Stimulated OSINT

Third party scanning services

MXtoolbox
Security Headers
Domaintools
UrlScan

### Social Engineering and Phishing

#### Domain Typo Squatting

### Active Data Collection

### Risks and Mitigations

## Wateringhole

# Enumerating Access Options

# Beachhead

# Internal Reconnaissance

# Orienteering

# Report Writing

You can use common [Markdown](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet) syntax to create your course, such as:

1. Lists
2. ordered or

   * unordered
   * ones ...


| Header 1   | Header 2   |
| :--------- | :--------- |
| Item 1     | Item 2     |


Images:

![images](https://farm2.static.flickr.com/1618/26701766821_7bea494826.jpg)


### Extensions

     --{{0}}--
But you can also include other features such as spoken text.

      --{{1}}--
Insert any kind of audio file:

       {{1}}
?[audio](https://bigsoundbank.com/UPLOAD/mp3/1068.mp3)


     --{{2}}--
Even videos or change the language completely.

       {{2-3}}
!?[video](https://www.youtube.com/watch?v=bICfKRyKTwE)


      --{{3 Russian Female}}--
Первоначально создан в 2004 году Джоном Грубером (англ. John Gruber) и Аароном
Шварцем. Многие идеи языка были позаимствованы из существующих соглашений по
разметке текста в электронных письмах...


    {{3}}
Type "voice" to see a list of all available languages.


### Styling

<!-- class = "animated rollIn" style = "animation-delay: 2s; color: purple" -->
The whole text-block should appear in purple color and with a wobbling effect.
Which is a **bad** example, please use it with caution ...
~~ only this is red ;-) ~~ <!-- class = "animated infinite bounce" style = "color: red;" -->

## Charts

Use ASCII-Art to draw diagrams:

                                    Multiline
    1.9 |    DOTS
        |                 ***
      y |               *     *
      - | r r r r r r r*r r r r*r r r r r r r
      a |             *         *
      x |            *           *
      i | B B B B B * B B B B B B * B B B B B
      s |         *                 *
        | *  * *                       * *  *
     -1 +------------------------------------
        0              x-axis               1

## Quizzes

### A Textquiz

What did the **fish** say when he hit a **concrete wall**?

    [[dam]]

### Multiple Choice

Just add as many points as you wish:

    [[X]] Only the **X** marks the correct point.
    [[ ]] Empty ones are wrong.
    [[X]] ...

### Single Choice

Just add as many points as you wish:

    [( )] ...
    [(X)] <-- Only the **X** is allowed.
    [( )] ...


## Executable Code

You can make your code executable and define projects:

``` js     -EvalScript.js
let who = data.first_name + " " + data.last_name;

if(data.online) {
  who + " is online"; }
else {
  who + " is NOT online"; }
```
``` json    +Data.json
{
  "first_name" :  "Sammy",
  "last_name"  :  "Shark",
  "online"     :  true
}
```
<script>
  // insert the JSON dataset into the local variable data
  let data = @input(1);

  // eval the script that uses this dataset
  eval(`@input(0)`);
</script>


## More

Find out what you also can do ...

https://LiaScript.github.io/course/?https://raw.githubusercontent.com/liaScript/docs/master/README.md